---
import '../styles/index.css';

import { getCollection, getEntry, render } from 'astro:content';
import { name, openGraph } from 'spectre:globals';
import ProfilePicture from '../assets/pfp.png';
import Card from '../components/Card.astro';
import Icon from '../components/Icon.astro';
import ImageGlow from '../components/ImageGlow.astro';
import Layout from '../layouts/Layout.astro';

const [posts, projects, about, workExperience, quickInfo, socials] = await Promise.all([
	getCollection('posts', (post) => post.data.draft !== true),
	getCollection('projects'),
	getEntry('other', 'about'),
	getCollection('workExperience'),
	getCollection('quickInfo'),
	getCollection('socials'),
]);

const { Content: About } = await render(about!);

// Fetch recently starred repos from GitHub
let starredRepos: any[] = [];
try {
	const res = await fetch('https://api.github.com/users/ompster/starred?per_page=100&sort=created&direction=desc', {
		headers: { 'User-Agent': 'nathanash-site' }
	});
	if (res.ok) starredRepos = await res.json();
} catch (e) {
	// Fail silently — just won't show the section
}

// Pick one random starred repo for the sidebar
const sidebarRepo = starredRepos.length > 0 ? starredRepos[Math.floor(Math.random() * starredRepos.length)] : null;

// 10 most recent for the main content
const recentStarred = starredRepos.slice(0, 10);
---

<Layout
	title={openGraph.home.title || name}
	description={openGraph.home.description}
	pagefindIgnore
>
	<div class="layout-grid-left" slot="left">
		<Card class="flex-col-card">
			<div class="pfp-container">
				<ImageGlow quality={100} width={120} height={120} src={ProfilePicture} alt="Nathan Ash pixel art avatar" loading='eager' />
			</div>
			<h2>{name}</h2>
			<p class="tagline">Done it more than once? Let's script it.</p>
			<ul class="overview-list">
				{quickInfo.map((info) => (
					<li>
						<Icon type={info.data.icon.type} name={info.data.icon.name as any} width={24} height={24} class='glow-icon' />
						<span>{info.data.text}</span>
					</li>
				))}
			</ul>
		</Card>
		<Card>
			<h3 class="no-mt">Socials</h3>
			<ul class="overview-list">
				{socials.map((item) => (
					<li>
						<a href={item.data.link} class="socials-link">
							<Icon type={item.data.icon.type} name={item.data.icon.name as any} width={24} height={24} class='glow-icon' />
							<span>{item.data.text}</span>
						</a>
					</li>
				))}
			</ul>
		</Card>
		{sidebarRepo && (
		<Card>
			<div class="header-container">
				<Icon type='lucide' name="star" width={24} height={24} class='glow-icon' />
				<h3 class="no-mt">Random Star ✨</h3>
			</div>
			<a href={sidebarRepo.html_url} target="_blank" rel="noopener noreferrer" class="starred-repo">
				<div class="starred-repo-header">
					<span class="starred-repo-name">{sidebarRepo.full_name}</span>
					<span class="starred-repo-stars">⭐ {sidebarRepo.stargazers_count.toLocaleString()}</span>
				</div>
				{sidebarRepo.description && (
					<span class="starred-repo-desc">{sidebarRepo.description.length > 120 ? sidebarRepo.description.substring(0, 120) + '…' : sidebarRepo.description}</span>
				)}
				{sidebarRepo.language && (
					<span class="starred-repo-lang">{sidebarRepo.language}</span>
				)}
			</a>
		</Card>
		)}
	</div>
	<div class="layout-grid-right" slot="right">
		<Card>
			<div class="header-container">
				<Icon type='lucide' name="user" width={24} height={24} class='glow-icon' />
				<h2>About me</h2>
			</div>
			<div class="prose">
				<About />
			</div>
		</Card>
		<Card>
			<div class="header-container">
				<Icon type='lucide' name="rss" width={24} height={24} class='glow-icon' />
				<h2>Latest Posts</h2>
			</div>
			<div class="content-container">
				{posts.sort((a, b) => b.data.createdAt.getTime() - a.data.createdAt.getTime()).slice(0, 2).map((post) => (
					<a href={`/blog/${post.id}`} class="post-container">
						<div class="post-header">
							<h3>{post.data.title}</h3>
							<span class="post-date">{post.data.createdAt.toLocaleDateString()}</span>
						</div>
						<span>{post.data.description}</span>
					</a>
				))}
			</div>
		</Card>
		{recentStarred.length > 0 && (
		<Card>
			<div class="header-container">
				<Icon type='lucide' name="star" width={24} height={24} class='glow-icon' />
				<h2>Recently Starred</h2>
			</div>
			<div class="starred-repos">
				{recentStarred.map((repo: any) => (
					<a href={repo.html_url} target="_blank" rel="noopener noreferrer" class="starred-repo">
						<div class="starred-repo-header">
							<span class="starred-repo-name">{repo.full_name}</span>
							<span class="starred-repo-stars">⭐ {repo.stargazers_count.toLocaleString()}</span>
						</div>
						{repo.description && (
							<span class="starred-repo-desc">{repo.description.length > 100 ? repo.description.substring(0, 100) + '…' : repo.description}</span>
						)}
						{repo.language && (
							<span class="starred-repo-lang">{repo.language}</span>
						)}
					</a>
				))}
			</div>
		</Card>
		)}
		<Card>
			<div class="header-container">
				<Icon type='lucide' name="folder-git" width={24} height={24} class='glow-icon' />
				<h2>Latest Projects</h2>
			</div>
			<div class="content-container">
				{projects.sort((a, b) => b.data.date.getTime() - a.data.date.getTime()).slice(0, 2).map((project) => (
					<a href={`/projects/${project.id}`} class="post-container">
						<div class="post-header">
							<h3>{project.data.title}</h3>
							<span class="post-date">{project.data.date.toLocaleDateString()}</span>
						</div>
						<span>{project.data.description}</span>
					</a>
				))}
			</div>
		</Card>
		<Card>
			<div class="header-container">
				<Icon type='lucide' name="briefcase-business" width={24} height={24} class='glow-icon' />
				<h2>Work Experience</h2>
			</div>
			<div class="work-experience-container">
				{workExperience.map((entry) => (
					<div class="work-experience-entry">
						<span class="work-experience-duration">{entry.data.duration}</span>
						<h3 class="work-experience-company">{entry.data.company}</h3>
						<span class="work-experience-role">{entry.data.title}</span>
						<p class="work-experience-desc">{entry.data.description}</p>
					</div>
				))}
			</div>
		</Card>
	</div>
</Layout>
